# FASE 1 - C√ìDIGO COMPLETO PARA A√ëADIR

## UBICACI√ìN: Despu√©s de la funci√≥n processExcel (l√≠nea ~750)

```javascript
// ========================================
// PROCESAMIENTO DE GAS - FASE 1
// ========================================

async function processGas(wb) {
    try {
        // Leer hojas de GAS
        const sheetNames = wb.SheetNames;
        const datosGasSheet = wb.Sheets['DATOSGAS'] || wb.Sheets['DatosGas'] || wb.Sheets['datosgas'];
        const comercialesGasSheet = wb.Sheets['COMERCIALESGAS'] || wb.Sheets['ComercialesGas'] || wb.Sheets['comercialesgas'];
        const facturasGasSheet = wb.Sheets[sheetNames.find(n => n.toUpperCase().includes('FACTURASGAS') || n.toUpperCase().includes('FACTURAS GAS'))];
        
        if (!facturasGasSheet) {
            console.log('No se encontr√≥ hoja de facturas de GAS');
            return null;
        }
        
        // Procesar DATOSGAS
        const tarifasGasMap = {};
        if (datosGasSheet) {
            const datosGasRaw = XLSX.utils.sheet_to_json(datosGasSheet, { header: 1 });
            
            for (let i = 1; i < datosGasRaw.length; i++) {
                const row = datosGasRaw[i];
                if (!row[0]) continue;
                
                const tarifa = String(row[0]).toUpperCase().trim();
                tarifasGasMap[tarifa] = {
                    'RL.1': parseFloat(row[1]) || 0,
                    'RL. 1': parseFloat(row[1]) || 0,
                    'RL1': parseFloat(row[1]) || 0,
                    'RL.2': parseFloat(row[2]) || 0,
                    'RL. 2': parseFloat(row[2]) || 0,
                    'RL2': parseFloat(row[2]) || 0,
                    'RL.3': parseFloat(row[3]) || 0,
                    'RL. 3': parseFloat(row[3]) || 0,
                    'RL3': parseFloat(row[3]) || 0,
                    'RL.4': parseFloat(row[4]) || 0,
                    'RL. 4': parseFloat(row[4]) || 0,
                    'RL4': parseFloat(row[4]) || 0,
                    'RL.5': parseFloat(row[5]) || 0,
                    'RL. 5': parseFloat(row[5]) || 0,
                    'RL5': parseFloat(row[5]) || 0
                };
            }
        }
        
        // Procesar COMERCIALESGAS
        const comercialesGasMap = {};
        const numeroComercialGasMap = {};
        
        if (comercialesGasSheet) {
            const comercialesGasRaw = XLSX.utils.sheet_to_json(comercialesGasSheet, { header: 1 });
            
            for (let i = 1; i < comercialesGasRaw.length; i++) {
                const row = comercialesGasRaw[i];
                if (!row[0]) continue;
                
                const agente = String(row[0]).toUpperCase().trim();
                const numeroComercial = row[1];
                const porcentaje = parseFloat(row[2]) || 0;
                
                let numero;
                if (typeof numeroComercial === 'number') {
                    numero = String(Math.floor(numeroComercial)).padStart(2, '0');
                } else {
                    const nums = String(numeroComercial).match(/\d+/);
                    numero = nums ? String(parseInt(nums[0])).padStart(2, '0') : '00';
                }
                
                comercialesGasMap[agente] = {
                    numeroComercial: numero,
                    porcentaje: porcentaje,
                    nombreOriginal: row[0]
                };
                
                if (!numeroComercialGasMap[numero]) {
                    numeroComercialGasMap[numero] = { nombres: [], porcentaje: porcentaje };
                }
                numeroComercialGasMap[numero].nombres.push(row[0]);
            }
        }
        
        // Procesar FACTURASGAS
        const facturaGasData = XLSX.utils.sheet_to_json(facturasGasSheet);
        const processedGas = [];
        const tarifasGasNoEncontradas = new Set();
        
        // Resetear tarifas y comerciales nuevos de gas
        tarifasGasNuevas = {};
        comercialesGasNuevos = {};
        
        for (const r of facturaGasData) {
            const comercial = r['Comercial'] || r['Identidad'] || '';
            const grupoOriginal = r['Grupo'] || '';
            const tarifaPeaje = r['Tarifa Peaje'] || r['TarifaPeaje'] || '';
            const consumo = parseFloat(r['Consumo'] || 0);
            
            if (!grupoOriginal || !consumo || !tarifaPeaje) continue;
            
            const grupo = String(grupoOriginal).toUpperCase().trim();
            const peaje = String(tarifaPeaje).toUpperCase().trim();
            
            // Buscar comisi√≥n base en DATOSGAS
            let comisionBase = 0;
            let tarifaData = tarifasGasMap[grupo];
            
            if (tarifaData) {
                comisionBase = tarifaData[peaje] || 0;
            } else {
                // Tarifa no encontrada - en Fase 4 preguntaremos
                tarifasGasNoEncontradas.add(JSON.stringify({ 
                    tarifa: grupoOriginal, 
                    peaje: peaje 
                }));
                continue;
            }
            
            // Buscar comercial en COMERCIALESGAS
            const comercialU = String(comercial).toUpperCase().trim();
            let comercialInfo = comercialesGasMap[comercialU];
            
            if (!comercialInfo) {
                // B√∫squeda parcial
                for (let k in comercialesGasMap) {
                    if (comercialU.includes(k) || k.includes(comercialU)) {
                        comercialInfo = comercialesGasMap[k];
                        break;
                    }
                }
            }
            
            if (!comercialInfo) {
                // Comercial no encontrado - en Fase 4 preguntaremos
                continue;
            }
            
            const numeroComercial = comercialInfo.numeroComercial;
            const pctComercial = comercialInfo.porcentaje;
            
            // F√ìRMULA GAS: (Consumo / 1000) * Comisi√≥nBase * %Comercial
            const consumoMWh = consumo / 1000;
            const comisionCalculada = consumoMWh * comisionBase * pctComercial;
            const formulaCalculo = `(${consumo}/1000)*${comisionBase}*${pctComercial.toFixed(2)}=${comisionCalculada.toFixed(2)} [GAS]`;
            
            // Extraer Serie y N√∫mero
            const serieNumero = r['Serie/Numero'] || r['Serie'] || '';
            let serie = '', numero = '';
            const match = String(serieNumero).match(/^([A-Z]+)(\d+)$/i);
            if (match) { 
                serie = match[1]; 
                numero = match[2]; 
            }
            
            // Formatear fechas
            const formatearFecha = (fecha) => {
                if (!fecha) return '';
                if (fecha instanceof Date) {
                    return fecha.toLocaleDateString('es-ES');
                }
                return String(fecha);
            };
            
            processedGas.push({
                'X': 'SigeCom.DTO.TablasMaestras.AgenteComisionDetailsDTO',
                'Agente': 'GAS-' + comercial,
                'Tipo Comision': 'Importe ‚Ç¨ kWh facturado',
                'Fecha': '',
                'Comisi√≥n': parseFloat(comisionCalculada.toFixed(2)),
                'Serie': serie,
                'Numero': numero,
                'Importe Base': consumo,
                'C√≥digo Contrato': r['Contrato'] || '',
                'Fecha Activaci√≥n': '',
                'CUPS': r['CUPS'] || '',
                'Identidad': r['Identidad'] || '',
                'Fecha Contrataci√≥n': formatearFecha(r['Fecha Factura']),
                'Fecha Desde': formatearFecha(r['Fecha Inicio Suministro']),
                'Fecha Hasta': formatearFecha(r['Fecha Fin Suministro']),
                'Grupo': grupoOriginal,
                'Cliente': r['Cliente'] || '',
                'Direcci√≥n': r['Direcci√≥n'] || '',
                'Tarifa Peaje': tarifaPeaje,
                'Tarifa': r['Tarifa'] || '',
                'F√≥rmula C√°lculo': formulaCalculo,
                '_numComercial': numeroComercial,
                '_agente': comercial
            });
        }
        
        if (processedGas.length === 0) {
            showStatus('‚ö†Ô∏è No se procesaron facturas de GAS', 'error');
            return null;
        }
        
        // Ordenar por comercial
        processedGas.sort((a, b) => {
            const numComp = (a._numComercial || 0) - (b._numComercial || 0);
            if (numComp !== 0) return numComp;
            return a._agente.localeCompare(b._agente);
        });
        
        // Agrupar por n√∫mero comercial
        const groupsGas = {};
        processedGas.forEach(r => {
            const numCom = r._numComercial;
            if (!groupsGas[numCom]) groupsGas[numCom] = [];
            groupsGas[numCom].push(r);
        });
        
        // Crear Excel con subtotales
        const finalGas = [];
        const resumenGas = [];
        let currentRow = 2;
        
        Object.keys(groupsGas).sort((a, b) => parseInt(a) - parseInt(b)).forEach(numCom => {
            const rows = groupsGas[numCom];
            const startRow = currentRow;
            
            rows.forEach(r => {
                delete r._numComercial;
                delete r._agente;
                finalGas.push(r);
                currentRow++;
            });
            
            const endRow = currentRow - 1;
            
            // Obtener nombre principal
            const nombrePrincipal = numeroComercialGasMap[numCom]?.nombres[0] || 'Comercial ' + numCom;
            const subtotal = rows.reduce((sum, r) => sum + (r['Comisi√≥n'] || 0), 0);
            
            resumenGas.push({
                numeroComercial: numCom,
                nombre: nombrePrincipal,
                subtotal: subtotal
            });
            
            finalGas.push({});
            currentRow++;
            finalGas.push({});
            currentRow++;
            
            finalGas.push({
                'X': '',
                'Agente': 'SUBTOTAL ' + nombrePrincipal,
                'Comisi√≥n': { f: `SUM(E${startRow}:E${endRow})` }
            });
            currentRow++;
            
            finalGas.push({
                'X': '',
                'Agente': 'SUBTOTAL CON IVA ' + nombrePrincipal,
                'Comisi√≥n': { f: `1.21*SUM(E${startRow}:E${endRow})` }
            });
            currentRow++;
            
            finalGas.push({});
            currentRow++;
            finalGas.push({});
            currentRow++;
        });
        
        const totalGas = resumenGas.reduce((s, a) => s + a.subtotal, 0);
        const totalIVAGas = totalGas * 1.21;
        
        // Crear HOJA SEPARADA para el resumen de GAS
        const resumenGasData = [];
        resumenGasData.push(['=== RESUMEN GAS (SIN IVA) ===']);
        resumenGasData.push([]);
        
        const rowInicioResumenGas = 3;
        resumenGas.sort((a, b) => parseInt(a.numeroComercial) - parseInt(b.numeroComercial));
        resumenGas.forEach(i => {
            resumenGasData.push([
                i.nombre,
                parseFloat(i.subtotal.toFixed(2)),
                i.numeroComercial
            ]);
        });
        const rowFinResumenGas = rowInicioResumenGas + resumenGas.length - 1;
        
        resumenGasData.push([]);
        resumenGasData.push([]);
        
        const rowTotalGeneralGas = rowFinResumenGas + 3;
        resumenGasData.push([
            'TOTAL GENERAL:',
            { f: `SUM(B${rowInicioResumenGas}:B${rowFinResumenGas})` }
        ]);
        
        resumenGasData.push([
            'TOTAL CON IVA:',
            { f: `B${rowTotalGeneralGas}*1.21` }
        ]);
        
        // Crear workbook de GAS
        const newWbGas = XLSX.utils.book_new();
        const wsGas = XLSX.utils.json_to_sheet(finalGas, { cellFormula: true });
        XLSX.utils.book_append_sheet(newWbGas, wsGas, 'Detalle GAS');
        
        // A√±adir hoja de resumen
        const wsResumenGas = XLSX.utils.aoa_to_sheet(resumenGasData);
        
        // Aplicar formato de moneda
        const rangeResumenGas = XLSX.utils.decode_range(wsResumenGas['!ref']);
        for (let R = 2; R <= rangeResumenGas.e.r; R++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: 1 });
            if (wsResumenGas[cellAddress] && typeof wsResumenGas[cellAddress].v === 'number') {
                wsResumenGas[cellAddress].z = '#,##0.00 "‚Ç¨"';
            }
        }
        
        XLSX.utils.book_append_sheet(newWbGas, wsResumenGas, 'Resumen GAS');
        
        // Hoja de tarifas no encontradas (si hay)
        if (tarifasGasNoEncontradas.size > 0) {
            const tarifasFaltantes = Array.from(tarifasGasNoEncontradas).map(t => {
                const obj = JSON.parse(t);
                return { 
                    'Tarifa': obj.tarifa, 
                    'Peaje': obj.peaje,
                    'Estado': 'Pendiente'
                };
            });
            const wsMissing = XLSX.utils.json_to_sheet(tarifasFaltantes);
            XLSX.utils.book_append_sheet(newWbGas, wsMissing, 'TARIFAS_GAS_NO_ENCONTRADAS');
        }
        
        processedWorkbookGas = newWbGas;
        processedDataByGroupGas = groupsGas;
        allProcessedDataGas = { numeroComercialGasMap, tarifasGasNoEncontradas };
        
        showStatus('‚úÖ GAS procesado: ' + processedGas.length + ' facturas', 'success');
        
        document.getElementById('downloadSectionGas').style.display = 'block';
        
        return newWbGas;
        
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        showStatus('‚ùå Error procesando GAS: ' + error.message, 'error');
        console.error(error);
        return null;
    }
}
```

## SIGUIENTE: Modificar handleFile para llamar a processGas

En la funci√≥n `handleFile`, despu√©s de llamar a `processExcel`, a√±adir:

```javascript
reader.onload = async (e) => {
    try {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
        await processExcel(wb);  // Electricidad
        await processGas(wb);    // GAS (nuevo)
    } catch (error) {
        //...
    }
};
```

## SIGUIENTE: A√±adir bot√≥n de descarga para GAS

En el HTML, despu√©s del `downloadSection` de electricidad, a√±adir:

```html
<div id="downloadSectionGas" style="display: none; margin-top: 20px;">
    <h3>üì¶ GAS - Descargar Excel Completo</h3>
    <button onclick="downloadExcelGas()" class="download-btn">
        üìä Descargar Excel GAS
    </button>
</div>
```

## SIGUIENTE: Funci√≥n downloadExcelGas

```javascript
function downloadExcelGas() {
    if (!processedWorkbookGas) {
        showStatus('‚ö†Ô∏è No hay datos de GAS procesados', 'error');
        return;
    }
    
    const timestamp = new Date().toISOString().split('T')[0];
    const wbout = XLSX.write(processedWorkbookGas, { bookType: 'xlsx', type: 'array', cellFormula: true });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Liquidaciones_GAS_${timestamp}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showStatus('‚úÖ Excel GAS descargado', 'success');
}
```

---

**¬øPROCEDO A IMPLEMENTAR TODO ESTO EN EL HTML?**

Escribe "S√ç FASE 1" para que aplique todos estos cambios.
