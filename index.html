<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Liquidaciones Comerciales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .content { padding: 40px; }
        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-section:hover { border-color: #764ba2; background: #f0f2ff; }
        .upload-section.dragover { background: #e8ebff !important; border-color: #764ba2 !important; transform: scale(1.02); }
        input[type="file"] { display: none; }
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .upload-btn:hover { transform: translateY(-2px); }
        .status { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .download-section { display: none; text-align: center; margin-top: 30px; padding: 30px; background: #f8f9ff; border-radius: 15px; }
        .download-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        .download-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .download-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .download-btn.script {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%);
        }
        .loading { text-align: center; padding: 20px; display: none; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .instructions {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        .instructions h3 { color: #856404; margin-bottom: 10px; }
        .instructions ul { margin-left: 20px; color: #856404; }
        .instructions li { margin: 5px 0; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 { font-size: 2em; margin-bottom: 5px; }
        .stat-card p { opacity: 0.9; font-size: 0.9em; }
        .drag-icon { font-size: 3em; margin-bottom: 10px; }
        .missing-tariffs {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .missing-tariffs h4 { color: #856404; margin-bottom: 10px; }
        .missing-tariffs ul { margin-left: 20px; color: #856404; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíº Calculadora de Liquidaciones Comerciales</h1>
            <p>Con f√≥rmulas Excel y exportaci√≥n por comercial</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>üìã Funcionalidades:</h3>
                <ul>
                    <li><strong>F√≥rmulas Excel</strong> en subtotales para verificaci√≥n</li>
                    <li><strong>Exportar todo</strong> ‚Üí Un Excel completo</li>
                    <li><strong>Exportar por comercial</strong> ‚Üí Un ZIP con archivos separados</li>
                    <li><strong>Script Mac</strong> ‚Üí Abre Outlook autom√°ticamente (requiere descarga separada)</li>
                    <li><strong>INDEX PLUS</strong> ‚Üí TOTAL (100%) | <strong>Resto</strong> ‚Üí REPARTO</li>
                </ul>
            </div>
            
            <div class="upload-section" id="uploadSection">
                <div class="drag-icon">üìÅ</div>
                <h2>Arrastra tu Excel aqu√≠</h2>
                <p style="margin: 20px 0; color: #666;">o haz clic para seleccionar</p>
                <label for="fileInput" class="upload-btn">Seleccionar Excel</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #667eea;">Procesando...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div class="missing-tariffs" id="missingTariffs">
                <h4>‚ö†Ô∏è Tarifas extra√≠das autom√°ticamente:</h4>
                <ul id="missingList"></ul>
                <p style="margin-top: 10px;"><strong>Hoja "TARIFAS_NO_ENCONTRADAS" creada</strong></p>
            </div>
            
            <div id="statsContainer"></div>
            
            <div class="download-section" id="downloadSection">
                <h2>‚úÖ Procesamiento Completado</h2>
                <p style="margin: 15px 0;">Elige c√≥mo descargar:</p>
                <button class="download-btn" id="downloadBtn">üì• Descargar Todo (Excel completo)</button>
                <br>
                <button class="download-btn secondary" id="downloadByComercialBtn">üì¶ Descargar por Comercial (ZIP)</button>
                <br>
                <button class="download-btn script" id="downloadScriptBtn">üçé Descargar Script Mac</button>
                <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    üí° <strong>Mac:</strong> Descarga ZIP + Script ‚Üí Ejecuta el script ‚Üí Outlook se abre con todos los emails
                </p>
            </div>
        </div>
    </div>

    <script>
        let processedWorkbook = null;
        let processedDataByGroup = null;
        let allProcessedData = null;
        
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadSection.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadSection.addEventListener(eventName, () => uploadSection.classList.add('dragover'), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadSection.addEventListener(eventName, () => uploadSection.classList.remove('dragover'), false);
        });
        
        uploadSection.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        }, false);
        
        document.getElementById('downloadBtn').addEventListener('click', downloadFile);
        document.getElementById('downloadByComercialBtn').addEventListener('click', downloadByComercial);
        document.getElementById('downloadScriptBtn').addEventListener('click', downloadScript);
        
        function showStatus(msg, type) {
            const s = document.getElementById('status');
            s.textContent = msg;
            s.className = 'status ' + type;
        }
        
        function limpiarNombre(nombre) {
            return nombre.replace(/[:\\\/\?\*\[\]]/g, '-').substring(0, 31);
        }
        
        function formatearFecha(fecha) {
            if (!fecha) return '';
            if (typeof fecha === 'string' && fecha.includes('-')) {
                const d = new Date(fecha);
                if (!isNaN(d.getTime())) {
                    return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
                }
                return fecha;
            }
            if (fecha instanceof Date && !isNaN(fecha.getTime())) {
                return `${String(fecha.getDate()).padStart(2, '0')}/${String(fecha.getMonth() + 1).padStart(2, '0')}/${fecha.getFullYear()}`;
            }
            if (typeof fecha === 'number') {
                const d = new Date((fecha - 25569) * 86400 * 1000);
                return `${String(d.getUTCDate()).padStart(2, '0')}/${String(d.getUTCMonth() + 1).padStart(2, '0')}/${d.getUTCFullYear()}`;
            }
            return '';
        }
        
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus('‚ö†Ô∏è Archivo inv√°lido', 'error');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('statsContainer').innerHTML = '';
            document.getElementById('status').style.display = 'none';
            document.getElementById('missingTariffs').style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    processExcel(wb);
                } catch (error) {
                    document.getElementById('loading').style.display = 'none';
                    showStatus('‚ùå Error: ' + error.message, 'error');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processExcel(wb) {
            try {
                const sheetNames = wb.SheetNames;
                const facturaSheet = wb.Sheets[sheetNames.find(n => n.toUpperCase().includes('FACTURA') || n.toUpperCase().includes('TOTAL'))];
                const datosSheet = wb.Sheets['DATOS'] || wb.Sheets['Datos'];
                const comisionesSheet = wb.Sheets['COMISIONES'] || wb.Sheets['Comisiones'];
                
                if (!facturaSheet || !datosSheet || !comisionesSheet) {
                    throw new Error('Faltan hojas necesarias');
                }
                
                const facturaData = XLSX.utils.sheet_to_json(facturaSheet);
                const datosRaw = XLSX.utils.sheet_to_json(datosSheet, { header: 1 });
                const comisionesRaw = XLSX.utils.sheet_to_json(comisionesSheet, { header: 1 });
                
                const tarifasMap = {};
                for (let i = 1; i < datosRaw.length; i++) {
                    if (datosRaw[i][0] && datosRaw[i][1] !== 'X') {
                        const tarifa = String(datosRaw[i][0]).toUpperCase().trim();
                        const comision = parseFloat(datosRaw[i][1]) || 0;
                        const tipo = datosRaw[i][2] ? String(datosRaw[i][2]).toUpperCase().trim() : null;
                        tarifasMap[tarifa] = { comision: comision, tipo: tipo };
                    }
                }
                
                const comercialesMap = {};
                const numeroComercialMap = {};
                
                for (let i = 1; i < comisionesRaw.length; i++) {
                    if (comisionesRaw[i][0]) {
                        const agente = String(comisionesRaw[i][0]).trim();
                        const agenteUpper = agente.toUpperCase();
                        const numeroComercial = comisionesRaw[i][1];
                        const porcentaje = parseFloat(comisionesRaw[i][2]) || 0;
                        
                        comercialesMap[agenteUpper] = {
                            numeroComercial: numeroComercial,
                            porcentaje: porcentaje,
                            nombreOriginal: agente
                        };
                        
                        if (!numeroComercialMap[numeroComercial]) {
                            numeroComercialMap[numeroComercial] = { nombres: [], porcentaje: porcentaje };
                        }
                        numeroComercialMap[numeroComercial].nombres.push(agente);
                    }
                }
                
                const processed = [];
                const tarifasNoEncontradas = new Set();
                
                facturaData.forEach(r => {
                    const comercial = r['Comercial'] || r['Identidad'] || '';
                    const grupoOriginal = r['Grupo'] || '';
                    const consumo = parseFloat(r['Consumo'] || 0);
                    if (!grupoOriginal || !consumo) return;
                    
                    const grupo = String(grupoOriginal).toUpperCase().trim();
                    
                    let tarifaData = tarifasMap[grupo];
                    
                    if (!tarifaData) {
                        const match = grupoOriginal.match(/\b(\d+)\b/g);
                        if (match) {
                            const numero = parseFloat(match[0]);
                            let tipoAuto = 'REPARTO';
                            if (grupo.includes('INDEX PLUS') || (grupo.includes('INDEX') && grupo.includes('PLUS'))) {
                                tipoAuto = 'TOTAL';
                            }
                            tarifaData = { comision: numero, tipo: tipoAuto };
                            tarifasNoEncontradas.add(JSON.stringify({ tarifa: grupoOriginal, comision: numero, tipo: tipoAuto }));
                        }
                    }
                    
                    if (!tarifaData) return;
                    
                    const comercialU = String(comercial).toUpperCase().trim();
                    let comercialInfo = comercialesMap[comercialU];
                    
                    if (!comercialInfo) {
                        for (let k in comercialesMap) {
                            if (comercialU.includes(k) || k.includes(comercialU)) {
                                comercialInfo = comercialesMap[k];
                                break;
                            }
                        }
                    }
                    
                    if (!comercialInfo) return;
                    
                    const numeroComercial = comercialInfo.numeroComercial;
                    const pctComercial = comercialInfo.porcentaje;
                    let pctFinal = pctComercial;
                    let tipoAplicado = tarifaData.tipo || 'REPARTO';
                    
                    if (tipoAplicado === 'TOTAL') pctFinal = 1.0;
                    
                    const consumoMWh = consumo / 1000;
                    const comision = tarifaData.comision;
                    const comisionCalculada = consumoMWh * comision * pctFinal;
                    const formulaCalculo = `(${consumo}/1000)*${comision}*${pctFinal.toFixed(2)}=${comisionCalculada.toFixed(2)} [${tipoAplicado}]`;
                    
                    const sn = String(r['Serie/Numero'] || '');
                    let serie = '', numero = sn;
                    const match = sn.match(/([A-Z]+)\s*(\d+)/);
                    if (match) { serie = match[1]; numero = match[2]; }
                    
                    processed.push({
                        'X': 'SigeCom.DTO.TablasMaestras.AgenteComisionDetailsDTO',
                        'Agente': comercial,
                        'Tipo Comision': 'Importe ‚Ç¨ kWh facturado',
                        'Fecha': '',
                        'Comisi√≥n': parseFloat(comisionCalculada.toFixed(2)),
                        'Serie': serie,
                        'Numero': numero,
                        'Importe Base': consumo,
                        'C√≥digo Contrato': r['Contrato'] || '',
                        'Fecha Activaci√≥n': '',
                        'CUPS': r['CUPS'] || '',
                        'Identidad': r['Identidad'] || '',
                        'Fecha Contrataci√≥n': formatearFecha(r['Fecha Factura']),
                        'Fecha Desde': formatearFecha(r['Fecha Inicio Suministro']),
                        'Fecha Hasta': formatearFecha(r['Fecha Fin Suministro']),
                        'Grupo': grupoOriginal,
                        'Cliente': r['Cliente'] || '',
                        'Direcci√≥n': r['Direcci√≥n'] || '',
                        'Tarifa Peaje': r['Tarifa Peaje'] || '',
                        'Tarifa': r['Tarifa'] || '',
                        'F√≥rmula C√°lculo': formulaCalculo,
                        '_numComercial': numeroComercial,
                        '_agente': comercial
                    });
                });
                
                if (tarifasNoEncontradas.size > 0) {
                    const missingDiv = document.getElementById('missingTariffs');
                    const missingList = document.getElementById('missingList');
                    missingList.innerHTML = '';
                    tarifasNoEncontradas.forEach(t => {
                        const obj = JSON.parse(t);
                        const li = document.createElement('li');
                        li.textContent = `${obj.tarifa} ‚Üí ${obj.comision} [${obj.tipo}]`;
                        missingList.appendChild(li);
                    });
                    missingDiv.style.display = 'block';
                }
                
                processed.sort((a, b) => {
                    const numComp = (a._numComercial || 0) - (b._numComercial || 0);
                    if (numComp !== 0) return numComp;
                    return a._agente.localeCompare(b._agente);
                });
                
                const groups = {};
                processed.forEach(r => {
                    const numCom = r._numComercial;
                    if (!groups[numCom]) groups[numCom] = [];
                    groups[numCom].push(r);
                });
                
                processedDataByGroup = groups;
                allProcessedData = { numeroComercialMap, tarifasNoEncontradas };
                
                const final = [];
                const resumen = [];
                let currentRow = 2;
                
                Object.keys(groups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(numCom => {
                    const rows = groups[numCom];
                    const startRow = currentRow;
                    
                    rows.forEach(r => {
                        delete r._numComercial;
                        delete r._agente;
                        final.push(r);
                        currentRow++;
                    });
                    
                    const endRow = currentRow - 1;
                    
                    const nombresGrupo = numeroComercialMap[numCom] ? numeroComercialMap[numCom].nombres : [];
                    const nombrePrincipal = nombresGrupo.length > 0 ? nombresGrupo[0] : 'Comercial ' + numCom;
                    
                    const sub = rows.reduce((s, r) => s + (parseFloat(r['Comisi√≥n']) || 0), 0);
                    resumen.push({ numeroComercial: numCom, nombre: nombrePrincipal, subtotal: sub });
                    
                    final.push({});
                    currentRow++;
                    final.push({});
                    currentRow++;
                    
                    final.push({
                        'X': '',
                        'Agente': 'SUBTOTAL ' + nombrePrincipal,
                        'Comisi√≥n': { f: `SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    final.push({
                        'X': '',
                        'Agente': 'SUBTOTAL CON IVA ' + nombrePrincipal,
                        'Comisi√≥n': { f: `1.21*SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    final.push({});
                    currentRow++;
                    final.push({});
                    currentRow++;
                });
                
                const total = resumen.reduce((s, a) => s + a.subtotal, 0);
                const totalIVA = total * 1.21;
                
                final.push({});
                final.push({ 'Agente': '=== RESUMEN (SIN IVA) ===' });
                final.push({});
                
                resumen.sort((a, b) => parseInt(a.numeroComercial) - parseInt(b.numeroComercial));
                resumen.forEach(i => {
                    final.push({ 'Agente': i.nombre, 'Numero': i.numeroComercial, 'Comisi√≥n': i.subtotal.toFixed(2) + ' ‚Ç¨' });
                });
                
                final.push({});
                final.push({});
                final.push({ 'Agente': 'TOTAL GENERAL:', 'Comisi√≥n': total.toFixed(2) + ' ‚Ç¨' });
                final.push({ 'Agente': 'TOTAL CON IVA:', 'Comisi√≥n': totalIVA.toFixed(2) + ' ‚Ç¨' });
                
                const newWb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(final, { cellFormula: true });
                XLSX.utils.book_append_sheet(newWb, ws, 'Hoja1');
                
                if (tarifasNoEncontradas.size > 0) {
                    const tarifasFaltantes = Array.from(tarifasNoEncontradas).map(t => {
                        const obj = JSON.parse(t);
                        return { 'Tarifa': obj.tarifa, 'Comisi√≥n extra√≠da': obj.comision, 'Tipo sugerido': obj.tipo };
                    });
                    const wsMissing = XLSX.utils.json_to_sheet(tarifasFaltantes);
                    XLSX.utils.book_append_sheet(newWb, wsMissing, 'TARIFAS_NO_ENCONTRADAS');
                }
                
                processedWorkbook = newWb;
                
                document.getElementById('statsContainer').innerHTML = `
                    <div class="stats">
                        <div class="stat-card"><h3>${processed.length}</h3><p>Facturas</p></div>
                        <div class="stat-card"><h3>${Object.keys(groups).length}</h3><p>Comerciales</p></div>
                        <div class="stat-card"><h3>${tarifasNoEncontradas.size}</h3><p>Extra√≠das</p></div>
                        <div class="stat-card"><h3>${total.toFixed(2)}‚Ç¨</h3><p>Total</p></div>
                    </div>
                `;
                
                document.getElementById('loading').style.display = 'none';
                showStatus(`‚úÖ ${processed.length} facturas procesadas`, 'success');
                document.getElementById('downloadSection').style.display = 'block';
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showStatus('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        function downloadFile() {
            if (!processedWorkbook) return;
            XLSX.writeFile(processedWorkbook, 'Comisiones_Completo_' + new Date().toISOString().split('T')[0] + '.xlsx');
            showStatus('‚úÖ Excel completo descargado', 'success');
        }
        
        async function downloadByComercial() {
            if (!processedDataByGroup) {
                showStatus('‚ùå No hay datos procesados', 'error');
                return;
            }
            
            try {
                showStatus('‚è≥ Generando archivos por comercial...', 'success');
                
                const zip = new JSZip();
                const { numeroComercialMap } = allProcessedData;
                
                Object.keys(processedDataByGroup).sort((a, b) => parseInt(a) - parseInt(b)).forEach(numCom => {
                    const rows = processedDataByGroup[numCom];
                    const nombresGrupo = numeroComercialMap[numCom] ? numeroComercialMap[numCom].nombres : [];
                    const nombrePrincipal = nombresGrupo.length > 0 ? nombresGrupo[0] : 'Comercial_' + numCom;
                    
                    const comercialData = [];
                    let currentRow = 2;
                    const startRow = currentRow;
                    
                    rows.forEach(r => {
                        const cleanRow = { ...r };
                        delete cleanRow._numComercial;
                        delete cleanRow._agente;
                        comercialData.push(cleanRow);
                        currentRow++;
                    });
                    
                    const endRow = currentRow - 1;
                    
                    comercialData.push({});
                    currentRow++;
                    comercialData.push({});
                    currentRow++;
                    
                    comercialData.push({
                        'X': '',
                        'Agente': 'SUBTOTAL ' + nombrePrincipal,
                        'Comisi√≥n': { f: `SUM(E${startRow}:E${endRow})` }
                    });
                    currentRow++;
                    
                    comercialData.push({
                        'X': '',
                        'Agente': 'SUBTOTAL CON IVA ' + nombrePrincipal,
                        'Comisi√≥n': { f: `1.21*SUM(E${startRow}:E${endRow})` }
                    });
                    
                    const wb = XLSX.utils.book_new();
                    const nombreHojaLimpio = limpiarNombre(nombrePrincipal);
                    const ws = XLSX.utils.json_to_sheet(comercialData, { cellFormula: true });
                    XLSX.utils.book_append_sheet(wb, ws, nombreHojaLimpio);
                    
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const nombreArchivoLimpio = `${String(numCom).padStart(2, '0')}_${nombrePrincipal.replace(/[^a-zA-Z0-9-]/g, '_')}`;
                    const fileName = `${nombreArchivoLimpio}.xlsx`;
                    
                    zip.file(fileName, wbout);
                });
                
                showStatus('‚è≥ Comprimiendo ZIP...', 'success');
                const content = await zip.generateAsync({ type: 'blob' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'Comisiones_Por_Comercial_' + new Date().toISOString().split('T')[0] + '.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('‚úÖ ZIP descargado correctamente', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        function downloadScript() {
            const scriptContent = `-- SCRIPT AUTOM√ÅTICO DE LIQUIDACIONES CON OUTLOOK
-- Este script busca autom√°ticamente el ZIP y Excel en Descargas
-- y crea emails en Outlook con archivos adjuntos

-- CONFIGURACI√ìN
set nombreRemitente to "Fernando"
set carpetaDescargas to (path to downloads folder as text)

try
    set rutaDescargas to POSIX path of carpetaDescargas
    
    -- Buscar ZIP m√°s reciente
    set comandoBuscarZIP to "find " & quoted form of rutaDescargas & " -name 'Comisiones_Por_Comercial_*.zip' -type f -mtime -1 | head -1"
    set archivoZIP to do shell script comandoBuscarZIP
    
    if archivoZIP is "" then
        display dialog "‚ùå No se encontr√≥ el archivo ZIP de comisiones en Descargas.

Por favor:
1. Descarga el ZIP desde la calculadora web
2. Ejecuta este script de nuevo" buttons {"OK"} default button 1 with icon stop
        return
    end if
    
    -- Buscar Excel original m√°s reciente
    set comandoBuscarExcel to "find " & quoted form of rutaDescargas & " -name '*.xlsx' -type f -mtime -1 ! -name 'Comisiones_*' ! -name '*~$*' | head -1"
    set archivoExcelOriginal to do shell script comandoBuscarExcel
    
    if archivoExcelOriginal is "" then
        display dialog "‚ùå No se encontr√≥ el Excel original en Descargas.

El Excel debe tener la hoja COMISIONES con:
- Columna D: Nombres
- Columnas E-H: Emails" buttons {"OK"} default button 1 with icon stop
        return
    end if
    
    -- Mostrar confirmaci√≥n
    set nombreZIP to do shell script "basename " & quoted form of archivoZIP
    set nombreExcel to do shell script "basename " & quoted form of archivoExcelOriginal
    
    display dialog "üìã Archivos encontrados:

ZIP: " & nombreZIP & "
Excel: " & nombreExcel & "

¬øProceder con el env√≠o de emails?" buttons {"Cancelar", "Continuar"} default button 2
    
    if button returned of result is "Cancelar" then
        return
    end if
    
on error errorMessage
    display dialog "‚ùå Error: " & errorMessage buttons {"OK"} default button 1 with icon stop
    return
end try

-- Descomprimir ZIP
set carpetaTemporal to (do shell script "mktemp -d") & "/"
do shell script "unzip -q " & quoted form of archivoZIP & " -d " & quoted form of carpetaTemporal

-- Obtener archivos Excel descomprimidos
set archivosExcel to paragraphs of (do shell script "find " & quoted form of carpetaTemporal & " -name '*.xlsx' -type f")

if (count of archivosExcel) is 0 then
    display dialog "‚ùå No se encontraron archivos Excel en el ZIP" buttons {"OK"} default button 1 with icon stop
    do shell script "rm -rf " & quoted form of carpetaTemporal
    return
end if

-- Leer datos de emails usando Python
set scriptPython to "
import sys
import subprocess

# Intentar importar openpyxl, si falla, instalarlo autom√°ticamente
try:
    import openpyxl
except ImportError:
    print('Instalando openpyxl...')
    subprocess.check_call([sys.executable, '-m', 'pip', 'install', '--user', 'openpyxl'])
    import openpyxl

import json

try:
    wb = openpyxl.load_workbook('" & archivoExcelOriginal & "', data_only=True)
    
    # Buscar hoja COMISIONES con variaciones
    hoja_comisiones = None
    for nombre_hoja in wb.sheetnames:
        if 'COMISION' in nombre_hoja.upper():
            hoja_comisiones = nombre_hoja
            break
    
    if not hoja_comisiones:
        print('ERROR: No se encuentra hoja de COMISIONES. Hojas disponibles: ' + ', '.join(wb.sheetnames))
        sys.exit(1)
    
    ws = wb[hoja_comisiones]
    datos = {}
    
    for row in ws.iter_rows(min_row=2, values_only=True):
        if row[1]:  # Columna B (N√∫mero comercial)
            numero = str(int(row[1])).zfill(2)  # Rellenar con ceros: 5 -> 05
            nombre = str(row[3]) if len(row) > 3 and row[3] else str(row[0])
            emails = []
            
            # Columnas E, F, G, H (√≠ndices 4, 5, 6, 7)
            for col_idx in range(4, min(8, len(row))):
                if row[col_idx] and '@' in str(row[col_idx]):
                    emails.append(str(row[col_idx]).strip())
            
            if emails:
                datos[numero] = {
                    'nombre': nombre,
                    'emails': emails
                }
    
    print(json.dumps(datos, ensure_ascii=False))
except Exception as e:
    print(f'ERROR: {str(e)}')
    sys.exit(1)
"

set datosJSON to do shell script "python3 -c " & quoted form of scriptPython

if datosJSON starts with "ERROR:" then
    display dialog "‚ùå " & datosJSON buttons {"OK"} default button 1 with icon stop
    do shell script "rm -rf " & quoted form of carpetaTemporal
    return
end if

-- Obtener mes actual
set scriptMes to "
import datetime
meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
print(meses[datetime.datetime.now().month - 1])
"
set mesActual to do shell script "python3 -c " & quoted form of scriptMes

-- Crear emails en Outlook
tell application "Microsoft Outlook"
    activate
    
    set scriptParsear to "
import json
datos = json.loads('''" & datosJSON & "''')
for numero, info in sorted(datos.items()):
    nombre = info['nombre']
    emails = ';'.join(info['emails'])
    print(f'{numero}|{nombre}|{emails}')
"
    
    set lineasDatos to paragraphs of (do shell script "python3 -c " & quoted form of scriptParsear)
    set contadorEmails to 0
    set comercialesSinArchivo to {}
    
    repeat with lineaDato in lineasDatos
        set AppleScript's text item delimiters to "|"
        set datosParte to text items of lineaDato
        set numeroComercial to item 1 of datosParte
        set nombreComercial to item 2 of datosParte
        set emailsDestino to item 3 of datosParte
        set AppleScript's text item delimiters to ""
        
        -- Buscar archivo Excel correspondiente
        set archivoEncontrado to missing value
        repeat with archivoPath in archivosExcel
            if archivoPath contains (numeroComercial & "_") then
                set archivoEncontrado to archivoPath
                exit repeat
            end if
        end repeat
        
        if archivoEncontrado is not missing value then
            -- Crear email
            set nuevoEmail to make new outgoing message with properties {subject:"Liquidaciones " & mesActual & " - " & nombreComercial}
            
            -- A√±adir destinatarios
            set AppleScript's text item delimiters to ";"
            set listaEmails to text items of emailsDestino
            set AppleScript's text item delimiters to ""
            
            repeat with unEmail in listaEmails
                make new recipient at nuevoEmail with properties {email address:{address:unEmail}}
            end repeat
            
            -- Crear cuerpo
            set contenido to "Buenos d√≠as " & nombreComercial & "," & return & return
            set contenido to contenido & "Te env√≠o las liquidaciones del mes de " & mesActual & "." & return & return
            set contenido to contenido & "Un saludo," & return
            set contenido to contenido & nombreRemitente
            
            set plain text content of nuevoEmail to contenido
            
            -- Adjuntar archivo
            tell nuevoEmail
                make new attachment with properties {file:POSIX file archivoEncontrado}
            end tell
            
            -- Abrir email
            open nuevoEmail
            
            set contadorEmails to contadorEmails + 1
            delay 1
        else
            set end of comercialesSinArchivo to nombreComercial
        end if
    end repeat
end tell

-- Limpiar y mostrar resultado
do shell script "rm -rf " & quoted form of carpetaTemporal

set mensaje to "‚úÖ Proceso completado

Emails creados: " & contadorEmails

if (count of comercialesSinArchivo) > 0 then
    set mensaje to mensaje & "

‚ö†Ô∏è Comerciales sin archivo Excel:
"
    repeat with comercial in comercialesSinArchivo
        set mensaje to mensaje & "- " & comercial & "
"
    end repeat
end if

set mensaje to mensaje & "

Los emails est√°n abiertos en Outlook.
Revisa y env√≠a cada uno."

display dialog mensaje buttons {"OK"} default button 1`;
            
            const blob = new Blob([scriptContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Enviar_Liquidaciones_Outlook.scpt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('‚úÖ Script descargado correctamente', 'success');
            alert('üì• Script descargado: Enviar_Liquidaciones_Outlook.scpt\n\n‚úÖ PASOS:\n\n1. Descarga primero el ZIP (bot√≥n rosa)\n2. Haz doble clic en el archivo .scpt descargado\n3. El script buscar√° autom√°ticamente los archivos\n4. Outlook abrir√° con todos los emails\n\n‚ö†Ô∏è REQUISITO (solo primera vez):\npip3 install openpyxl');
        }
    </script>
</body>
</html>
