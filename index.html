<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Liquidaciones Comerciales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .content { padding: 40px; }
        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s;
        }
        .upload-section:hover { border-color: #764ba2; background: #f0f2ff; }
        .upload-section.dragover { background: #e8ebff; border-color: #764ba2; transform: scale(1.02); }
        input[type="file"] { display: none; }
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .status { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .download-section { display: none; text-align: center; margin-top: 30px; padding: 30px; background: #f8f9ff; border-radius: 15px; }
        .download-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }
        .download-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 153, 142, 0.6); }
        .loading { text-align: center; padding: 20px; display: none; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .instructions {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        .instructions h3 { color: #856404; margin-bottom: 10px; }
        .instructions ul { margin-left: 20px; color: #856404; }
        .instructions li { margin: 5px 0; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 { font-size: 2em; margin-bottom: 5px; }
        .stat-card p { opacity: 0.9; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’¼ Calculadora de Liquidaciones Comerciales</h1>
            <p>Procesamiento automÃ¡tico con subtotales por agente y resumen final</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>ðŸ“‹ Instrucciones:</h3>
                <ul>
                    <li>Tu Excel debe contener 3 hojas: <strong>FACTURA TOTAL</strong>, <strong>DATOS</strong>, y <strong>COMISIONES</strong></li>
                    <li>Se generarÃ¡n <strong>subtotales por cada agente</strong> (SIN IVA y CON IVA)</li>
                    <li>Al final se aÃ±adirÃ¡ un <strong>resumen completo</strong> con todos los agentes ordenados</li>
                    <li>Columnas adicionales: Grupo, Cliente, DirecciÃ³n, Tarifa Peaje, Tarifa</li>
                </ul>
            </div>
            
            <div class="upload-section" id="uploadSection">
                <h2>ðŸ“¤ Sube tu archivo Excel</h2>
                <p style="margin: 20px 0; color: #666;">Arrastra y suelta tu archivo aquÃ­ o haz clic en el botÃ³n</p>
                <label for="fileInput" class="upload-btn">Seleccionar Excel</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #667eea;">Procesando archivo...</p>
            </div>
            
            <div class="status" id="status"></div>
            <div id="statsContainer"></div>
            
            <div class="download-section" id="downloadSection">
                <h2>âœ… Procesamiento completado</h2>
                <p style="margin: 15px 0;">Tu archivo estÃ¡ listo con subtotales y resumen</p>
                <button class="download-btn" id="downloadBtn">ðŸ“¥ Descargar Excel de Comisiones</button>
            </div>
        </div>
    </div>

    <script>
        let processedWorkbook = null;
        
        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });
        
        document.getElementById('downloadBtn').addEventListener('click', downloadFile);
        
        function showStatus(msg, type) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = 'status ' + type;
        }
        
        function handleFile(file) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    processExcel(wb);
                } catch (error) {
                    document.getElementById('loading').style.display = 'none';
                    showStatus('Error: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processExcel(wb) {
            try {
                const sheetNames = wb.SheetNames;
                const facturaSheet = wb.Sheets[sheetNames.find(n => n.toUpperCase().includes('FACTURA') || n.toUpperCase().includes('TOTAL'))];
                const datosSheet = wb.Sheets['DATOS'] || wb.Sheets['Datos'];
                const comisionesSheet = wb.Sheets['COMISIONES'] || wb.Sheets['Comisiones'];
                
                if (!facturaSheet || !datosSheet || !comisionesSheet) {
                    throw new Error('Faltan hojas necesarias');
                }
                
                const facturaData = XLSX.utils.sheet_to_json(facturaSheet);
                const datosRaw = XLSX.utils.sheet_to_json(datosSheet, { header: 1 });
                const comisionesRaw = XLSX.utils.sheet_to_json(comisionesSheet, { header: 1 });
                
                // Mapas
                const fees = {}, coms = {};
                for (let i = 1; i < datosRaw.length; i++) {
                    if (datosRaw[i][0]) fees[String(datosRaw[i][0]).toUpperCase().trim()] = parseFloat(datosRaw[i][1]) || 0;
                }
                for (let i = 1; i < comisionesRaw.length; i++) {
                    if (comisionesRaw[i][0]) coms[String(comisionesRaw[i][0]).toUpperCase().trim()] = parseFloat(comisionesRaw[i][2]) || 0;
                }
                
                const processed = [];
                
                facturaData.forEach(r => {
                    const comercial = r['Comercial'] || r['Identidad'] || '';
                    const grupo = r['Grupo'] || '';
                    const consumo = parseFloat(r['Consumo'] || 0);
                    if (!grupo || !consumo) return;
                    
                    const grupoU = String(grupo).toUpperCase().trim();
                    let fee = fees[grupoU] || 0;
                    if (!fee) {
                        for (let k in fees) {
                            if (grupoU.includes(k) || k.includes(grupoU)) { fee = fees[k]; break; }
                        }
                    }
                    if (!fee) {
                        const m = grupo.match(/\b(\d+)\b/g);
                        if (m) fee = parseFloat(m[0]);
                    }
                    
                    const comercialU = String(comercial).toUpperCase().trim();
                    let pct = coms[comercialU] || 0;
                    if (!pct) {
                        for (let k in coms) {
                            if (comercialU.includes(k) || k.includes(comercialU)) { pct = coms[k]; break; }
                        }
                    }
                    
                    const comision = (consumo / 1000) * fee * pct;
                    
                    const sn = String(r['Serie/Numero'] || '');
                    let serie = '', numero = sn;
                    const match = sn.match(/([A-Z]+)\s*(\d+)/);
                    if (match) { serie = match[1]; numero = match[2]; }
                    
                    processed.push({
                        'X': 'SigeCom.DTO.TablasMaestras.AgenteComisionDetailsDTO',
                        'Agente': comercial,
                        'Tipo Comision': 'Importe â‚¬ kWh facturado',
                        'Fecha': '',
                        'ComisiÃ³n': parseFloat(comision.toFixed(2)),
                        'Serie': serie,
                        'Numero': numero,
                        'Importe Base': consumo,
                        'CÃ³digo Contrato': r['Contrato'] || '',
                        'Fecha ActivaciÃ³n': '',
                        'CUPS': r['CUPS'] || '',
                        'Identidad': r['Identidad'] || '',
                        'Fecha ContrataciÃ³n': r['Fecha Factura'] ? String(r['Fecha Factura']) : '',
                        'Fecha Desde': r['Fecha Inicio Suministro'] ? String(r['Fecha Inicio Suministro']) : '',
                        'Fecha Hasta': r['Fecha Fin Suministro'] ? String(r['Fecha Fin Suministro']) : '',
                        'Grupo': grupo,
                        'Cliente': r['Cliente'] || '',
                        'DirecciÃ³n': r['DirecciÃ³n'] || '',
                        'Tarifa Peaje': r['Tarifa Peaje'] || '',
                        'Tarifa': r['Tarifa'] || '',
                        '_ag': comercial,
                        '_num': numero
                    });
                });
                
                processed.sort((a, b) => {
                    const c = a._ag.localeCompare(b._ag);
                    return c !== 0 ? c : (parseInt(a._num) || 0) - (parseInt(b._num) || 0);
                });
                
                processed.forEach(r => { delete r._ag; delete r._num; });
                
                // Agrupar por agente
                const groups = {};
                processed.forEach(r => {
                    const ag = r['Agente'];
                    if (!groups[ag]) groups[ag] = [];
                    groups[ag].push(r);
                });
                
                const final = [];
                const resumen = [];
                
                Object.keys(groups).forEach(ag => {
                    const rows = groups[ag];
                    rows.forEach(r => final.push(r));
                    
                    const sub = rows.reduce((s, r) => s + (r['ComisiÃ³n'] || 0), 0);
                    const subIVA = sub * 1.21;
                    
                    resumen.push({ agente: ag, subtotal: sub });
                    
                    final.push({}, {});
                    final.push({ 'ComisiÃ³n': `SUBTOTAL ${ag}:`, 'Importe Base': sub.toFixed(2) });
                    final.push({ 'ComisiÃ³n': `SUBTOTAL CON IVA ${ag}:`, 'Importe Base': subIVA.toFixed(2) });
                    final.push({}, {});
                });
                
                const total = resumen.reduce((s, a) => s + a.subtotal, 0);
                const totalIVA = total * 1.21;
                
                final.push({}, { 'ComisiÃ³n': '=== RESUMEN POR AGENTE (SIN IVA) ===' }, {});
                
                resumen.sort((a, b) => b.subtotal - a.subtotal);
                resumen.forEach(i => {
                    final.push({ 'ComisiÃ³n': i.agente, 'Numero': i.subtotal.toFixed(2) + ' â‚¬' });
                });
                
                final.push({}, {});
                final.push({ 'ComisiÃ³n': 'TOTAL GENERAL:', 'Numero': total.toFixed(2) + ' â‚¬' });
                final.push({ 'ComisiÃ³n': 'TOTAL GENERAL CON IVA:', 'Numero': totalIVA.toFixed(2) + ' â‚¬' });
                
                const newWb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(final);
                XLSX.utils.book_append_sheet(newWb, ws, 'Hoja1');
                processedWorkbook = newWb;
                
                document.getElementById('statsContainer').innerHTML = `
                    <div class="stats">
                        <div class="stat-card"><h3>${processed.length}</h3><p>Facturas</p></div>
                        <div class="stat-card"><h3>${Object.keys(groups).length}</h3><p>Agentes</p></div>
                        <div class="stat-card"><h3>${total.toFixed(2)}â‚¬</h3><p>Total</p></div>
                        <div class="stat-card"><h3>${totalIVA.toFixed(2)}â‚¬</h3><p>Con IVA</p></div>
                    </div>
                `;
                
                document.getElementById('loading').style.display = 'none';
                showStatus(`âœ… Procesadas ${processed.length} lÃ­neas con ${Object.keys(groups).length} agentes`, 'success');
                document.getElementById('downloadSection').style.display = 'block';
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showStatus('Error: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        function downloadFile() {
            if (!processedWorkbook) return;
            const fileName = 'Comisiones_' + new Date().toISOString().split('T')[0] + '.xlsx';
            XLSX.writeFile(processedWorkbook, fileName);
            showStatus('âœ… Descargado: ' + fileName, 'success');
        }
    </script>
</body>
</html>
